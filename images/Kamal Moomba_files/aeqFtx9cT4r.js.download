if (self.CavalryLogger) { CavalryLogger.start_js(["DPETj"]); }

__d("FBRTCIncomingCallController",["fbt","Cache","DocumentTitle","FBRTCCallBlockingStore","FBRTCCallSummary","FBRTCCallSummaryStore","FBRTCCallUIWrapper","FBRTCConstants","FBRTCLocalMessageQueue","FBRTCLocalUploadLogLevel","FBRTCLogger","FBRTCMessage","FBRTCMessageDedup","FBRTCMessageSender","FBRTCSupport","MercuryIDs","MessengerParticipants.bs","UserActivity"],(function(a,b,c,d,e,f,g){__p&&__p();var h=30;function a(a,c,d){"use strict";this.$1=a,this.$2=c,this.$3=d,this.$4=null,this.$5=null,this.$6=new(b("FBRTCMessageSender"))(),this.$7=new(b("FBRTCLocalMessageQueue"))(),this.$8=b("FBRTCCallSummaryStore").getInstance(),this.$9=b("FBRTCLogger").getInstance(),this.$10=null,this.$11=new(b("Cache"))()}a.prototype.onMessageReceived=function(a){"use strict";__p&&__p();var c=void 0;try{c=new(b("FBRTCMessage"))(a)}catch(b){this.$9.logErrorWithoutID("Unknown data: "+JSON.stringify(a));return}if(!b("FBRTCMessageDedup").check(c.peerID,c.callID,c.msgID)){c.isOffer()&&this.$12(c)&&this.$6.sendOfferAck(c.peerID,c.callID,c.msg);this.$9.logInfo(c.peerID,c.callID,"Ignoring message (duplicate): "+c.msgID);return}this.$9.logReceivedMessage(c.peerID,c.callID,c.msg);b("FBRTCSupport").isWebrtcSupported()&&c.msgType!==b("FBRTCConstants").PayloadType.OFFER&&this.$7.enqueueMessage(c.peerID,c.callID,c.msgID,a);switch(c.msgType){case b("FBRTCConstants").PayloadType.OFFER:this.$13(c);break;case b("FBRTCConstants").PayloadType.HANGUP:this.$14(c);break;case b("FBRTCConstants").PayloadType.OTHER_DISMISS:this.$15(c);break;case b("FBRTCConstants").PayloadType.ICE_CANDIDATE:case b("FBRTCConstants").PayloadType.OFFER_ACK:case b("FBRTCConstants").PayloadType.ANSWER:case b("FBRTCConstants").PayloadType.MSG_ACK:case b("FBRTCConstants").PayloadType.OK:case b("FBRTCConstants").PayloadType.PING:case b("FBRTCConstants").PayloadType.PRANSWER:case b("FBRTCConstants").PayloadType.ICERESTART_OFFER:case b("FBRTCConstants").PayloadType.ICERESTART_ANSWER:case b("FBRTCConstants").PayloadType.PCRESTART_ANSWER:case b("FBRTCConstants").PayloadType.PCRESTART_OFFER:case b("FBRTCConstants").PayloadType.SDP_UPDATE:case b("FBRTCConstants").PayloadType.ANSWER_ACK:case b("FBRTCConstants").PayloadType.SET_VIDEO:case b("FBRTCConstants").PayloadType.OFFER_NACK:case b("FBRTCConstants").PayloadType.VIDEO_REQUEST:case b("FBRTCConstants").PayloadType.ACK:break;default:break}};a.prototype.$13=function(a){"use strict";__p&&__p();var c=a.callID;void 0;var d=a.msg,e=a.peerID;if(this.$16(c))return;if(d.calltype){this.$6.sendOfferNack(e,c,d);return}this.$12(a)?this.$6.sendOfferAck(e,c,d):b("FBRTCSupport").isWebrtcSupported()||this.$6.sendOfferNack(e,c,d);this.$9.logCallAction(e,c,b("FBRTCLogger").CallAction.RECEIVED_CALL);var f=this.$17(e,c,a);f.setUploadLogLevel(b("FBRTCLocalUploadLogLevel").getUploadLogLevel(b("FBRTCConstants").convertToUploadLogLevel(d.ull)));if(b("FBRTCCallBlockingStore").getBlockingStatus()){this.$18(e,c,f,b("FBRTCConstants").CallEndReason.IGNORE_CALL,!1,!1,!1,"calling disabled");return}if(this.$4!==null&&!this.$4.isForPeer(e)){this.$18(e,c,f,b("FBRTCConstants").CallEndReason.IN_ANOTHER_CALL,!1,!1,!0);this.$3.onCallMissed(e);return}if(!b("FBRTCSupport").isWebrtcSupported()){this.$18(e,c,f,b("FBRTCConstants").CallEndReason.UNSUPPORTED_VERSION,!1,!1,!1);this.$2.showForIncomingCall(c,e);return}this.$4=new this.$1(e,c);this.$5=f;this.$4.addListener("answerCall",function(){this.$19(e,c,a,f)}.bind(this));this.$4.addListener("ignoreCall",function(){this.$20(e,c,f)}.bind(this));this.$4.addListener("timeout",function(){this.$21(e,c,f)}.bind(this));this.$3.hideDialog();d=d.videoon?b("FBRTCConstants").IncomingCallDialogTypes.VIDEO:b("FBRTCConstants").IncomingCallDialogTypes.AUDIO;this.$4.showIncomingDialog(d);this.$9.logEvent(e,c,"Incoming call dialog shown");this.$22(e)};a.prototype.$22=function(a){"use strict";document.hasFocus()||this.$23(a)};a.prototype.$24=function(){"use strict";this.$25()};a.prototype.$23=function(a){"use strict";a=b("MercuryIDs").getParticipantIDFromUserID(a);b("MessengerParticipants.bs").get(a,function(a){if(!this.$4)return;this.$10=b("DocumentTitle").blink(g._("{name} is calling",[g._param("name",a.short_name)]))}.bind(this));b("UserActivity").subscribeOnce(this.$25.bind(this))};a.prototype.$25=function(){"use strict";this.$10&&(this.$10.stop(),this.$10=null)};a.prototype.$26=function(){"use strict";this.$4&&this.$4.cancel(),this.$4=null,this.$5=null,this.$24()};a.prototype.$14=function(a){"use strict";__p&&__p();var c=a.peerID,d=a.callID;a=a.msg;this.$27(d);if(this.$4&&this.$4.isForPeerAndCall(c,d)){a=a.reason;(typeof a==="string"||a instanceof String)&&(a=b("FBRTCConstants").endCallReasonFromString(a));this.$18(c,d,this.$5,a,!0,!0,!1);this.$26();a!==b("FBRTCConstants").CallEndReason.OTHER_INSTANCE_HANDLED&&(this.$3.onCallMissed(c),this.$3.showDialog())}};a.prototype.$12=function(a){"use strict";return b("FBRTCSupport").isWebrtcSupported()};a.prototype.$15=function(a){"use strict";a=a.callID;this.$27(a);b("FBRTCSupport").isWebrtcSupported()||this.$2.dismiss();this.$4&&this.$4.isForCall(a)&&this.$26()};a.prototype.$27=function(a){"use strict";this.$11.set(a,!0,null,h)};a.prototype.$16=function(a){"use strict";return this.$11.has(a)};a.prototype.$17=function(a,c,d){"use strict";a=new(b("FBRTCCallSummary"))({peerID:a,callID:c,isCaller:!1});a.setCallTrigger("incoming_p2p_ring_dialog");a.onFullMessageReceived(d);a.onOfferAckSent(d.msg);return a};a.prototype.$19=function(a,c,d,e){"use strict";var f=!d.msg.videoon;e.onPressedAnswer();e.save(this.$8);this.$9.logCallAction(a,c,b("FBRTCLogger").CallAction.ANSWER_CALL);this.$6.sendOtherDismiss(c);this.$7.enqueueOffer(a,d.originalMessageData);b("FBRTCCallUIWrapper").openAsCallee(a,c,e,f);this.$26()};a.prototype.$20=function(a,c,d){"use strict";this.$18(a,c,d,b("FBRTCConstants").CallEndReason.IGNORE_CALL,!1,!0,!0),this.$26()};a.prototype.$21=function(a,c,d){"use strict";this.$18(a,c,d,b("FBRTCConstants").CallEndReason.NO_ANSWER_TIMEOUT,!1,!1,!1),this.$26(),this.$3.onCallMissed(a),this.$3.showDialog()};a.prototype.$18=function(a,c,d,e,f,g,h){var i=arguments.length<=7||arguments[7]===undefined?null:arguments[7];h&&this.$6.sendHangup(a,c,e);g&&this.$6.sendOtherDismiss(c);d.onCallEnded(e,f,null,i);d.save(this.$8);var j=b("FBRTCConstants").fullCallEndReasonString(e,f);this.$9.logCallAction(a,c,b("FBRTCLogger").CallAction.END_CALL,j)};e.exports=a}),null);
__d("FBRTCSoundController",["RTCConfig","Sound"],(function(a,b,c,d,e,f){var g=[b("RTCConfig").ringtone_mp3_url,b("RTCConfig").ringtone_ogg_url];a={playIncomingRingtone:function(a,c,d){a=["incoming_ringtone",a.toString(),c.toString()].join("_");b("Sound").play(g,a,d)},stopIncomingRingtone:function(){b("Sound").stop(g)}};e.exports=a}),null);
__d("XIncomingCallDialogController",["XController"],(function(a,b,c,d,e,f){e.exports=b("XController").create("/videocall/incoming/",{user_id:{type:"FBID",required:!0},call_id:{type:"Int"},dialog_type:{type:"String",defaultValue:"VIDEO"},__asyncDialog:{type:"Int"}})}),null);
__d("FBRTCIncomingCallDialog",["AsyncDialog","AsyncRequest","Dialog","FBRTCSoundController","VideoCallTypedLogger","XIncomingCallDialogController","clearTimeout","mixInEventEmitter","setTimeoutAcrossTransitions"],(function(a,b,c,d,e,f){__p&&__p();var g=7e4;function a(a,b){"use strict";this.peerID=a,this.callID=b,this.$1=null}a.prototype.showIncomingDialog=function(a){"use strict";var c=b("Dialog").getCurrent();c&&c.hide();c=b("XIncomingCallDialogController").getURIBuilder().setFBID("user_id",this.peerID).setInt("call_id",this.callID).setString("dialog_type",a).getURI();this.$1=new(b("AsyncRequest"))(c);b("AsyncDialog").send(this.$1,this.$2.bind(this))};a.prototype.$2=function(a){"use strict";__p&&__p();if(!this.$1){setTimeout(function(){a.hide()},1);return}this.$1=null;this.view=a;a.subscribe("confirm",this.$3.bind(this));a.subscribe("cancel",this.$4.bind(this));b("FBRTCSoundController").playIncomingRingtone(this.callID,this.peerID,!0);this.timeout=b("setTimeoutAcrossTransitions")(this.$5.bind(this),g)};a.prototype.cancel=function(){"use strict";this.$1&&(this.$1.abort(),this.$1=null),this.timeout&&b("clearTimeout")(this.timeout),this.view&&(this.view.hide(),this.view=null),b("FBRTCSoundController").stopIncomingRingtone()};a.prototype.isForPeer=function(a){"use strict";return this.peerID===a};a.prototype.isForCall=function(a){"use strict";return this.callID===a};a.prototype.isForPeerAndCall=function(a,b){"use strict";return this.peerID===a&&this.callID===b};a.prototype.$3=function(a,c){"use strict";this.cancel(),new(b("VideoCallTypedLogger"))().setEvent("accept_call_click").log(),this.emit("answerCall")};a.prototype.$4=function(){"use strict";this.cancel(),this.emit("ignoreCall")};a.prototype.$5=function(){"use strict";this.cancel(),this.emit("timeout")};b("mixInEventEmitter")(a,{answerCall:!0,ignoreCall:!0,timeout:!0});e.exports=a}),null);
__d("XVideoCallMissedCallController",["XController"],(function(a,b,c,d,e,f){e.exports=b("XController").create("/videocall/missed_call/",{user_id:{type:"Int",required:!0},__asyncDialog:{type:"Int"}})}),null);
__d("XVideoCallMissedCallDialogController",["XController"],(function(a,b,c,d,e,f){e.exports=b("XController").create("/videocall/dismiss_all_missed_call_dialog/",{})}),null);
__d("FBRTCMissedVideoCallHandler",["Arbiter","AsyncDialog","AsyncRequest","ChannelConstants","FBRTCCore","FBRTCLogger","FBRTCSupport","XVideoCallMissedCallController","XVideoCallMissedCallDialogController"],(function(a,b,c,d,e,f){__p&&__p();var g=null,h=null,i=null;a.prototype.hideDialog=function(){"use strict";g&&(g.hide(),g=null,h=null,i&&(i.unsubscribe(),i=null))};function a(){"use strict";this.$1=null}a.prototype.onCallMissed=function(a){"use strict";if(!b("FBRTCSupport").isWebrtcSupported())return;h===null&&(this.$1=a)};a.prototype.showDialog=function(){"use strict";if(!this.$1||h)return;h=this.$1;this.$1=null;var a=b("XVideoCallMissedCallController").getURIBuilder().setInt("user_id",h).getURI();a=new(b("AsyncRequest"))(a);b("AsyncDialog").send(a,this.$2.bind(this))};a.prototype.$2=function(a){"use strict";g=a,a.subscribe("confirm",this.$3.bind(this)),a.subscribe("cancel",this.$4.bind(this)),i=b("Arbiter").subscribe(b("ChannelConstants").getArbiterType("dismiss_all_missed_call_dialog"),this.$5.bind(this))};a.prototype.$3=function(){"use strict";b("FBRTCCore").startOutgoingCall(h,b("FBRTCLogger").Trigger.RETURN_CALL,!1),this.$4()};a.prototype.$4=function(){"use strict";this.hideDialog(),this.$6()};a.prototype.$6=function(){"use strict";new(b("AsyncRequest"))(b("XVideoCallMissedCallDialogController").getURIBuilder().getURI()).send()};a.prototype.$5=function(){"use strict";this.hideDialog()};e.exports=a}),null);
__d("XBrowserNotSupportedDialogController",["XController"],(function(a,b,c,d,e,f){e.exports=b("XController").create("/videocall/browser_not_supported/",{is_group_call:{type:"Bool",defaultValue:!1},participants:{type:"StringVector"},user_id:{type:"Int"},warning:{type:"Bool",defaultValue:!1},call_type:{type:"Enum",defaultValue:2,enumType:0},__asyncDialog:{type:"Int"}})}),null);
__d("FBRTCUnsupportedBrowserMessage",["AsyncDialog","AsyncRequest","FBRTCCallConstants","FBRTCSoundController","XBrowserNotSupportedDialogController"],(function(a,b,c,d,e,f){__p&&__p();var g=b("FBRTCCallConstants").FBRTCCallType;a={_dialog:null,warnForOutgoingCall:function(a){var c=b("XBrowserNotSupportedDialogController").getURIBuilder().setBool("warning",!0).getURI();this._presentDialog(c,a)},showForOutgoingCall:function(){var a=b("XBrowserNotSupportedDialogController").getURIBuilder().getURI();this._presentDialog(a)},showForIncomingCall:function(a,c){b("FBRTCSoundController").playIncomingRingtone(a,c,!1);a=b("XBrowserNotSupportedDialogController").getURIBuilder().setInt("user_id",c).getURI();this._presentDialog(a)},showForIncomingGroupCall:function(a,c,d,e){b("FBRTCSoundController").playIncomingRingtone(a,e,!1);a=b("XBrowserNotSupportedDialogController").getURIBuilder().setBool("is_group_call",!0).setInt("user_id",d).setStringVector("participants",c).getURI();this._presentDialog(a)},showForOutgoingGroupCall:function(){var a=b("XBrowserNotSupportedDialogController").getURIBuilder().setBool("is_group_call",!0).getURI();this._presentDialog(a)},showForUnsupportedCollabCall:function(){var a=b("XBrowserNotSupportedDialogController").getURIBuilder().setEnum("call_type",g.COLLAB_VIDEO_CALL).getURI();this._presentDialog(a)},showForUnsupportedCollabScreenSharing:function(){var a=b("XBrowserNotSupportedDialogController").getURIBuilder().setEnum("call_type",g.COLLAB_SCREEN_SHARE_CALL).getURI();this._presentDialog(a)},dismiss:function(){this._dialog&&this._dialog.hide()},_presentDialog:function(a,c){if(this._dialog)return;a=new(b("AsyncRequest"))(a);b("AsyncDialog").send(a,function(a){this._dialog=a,a.subscribe("hide",function(){this._dialog=null,c&&c()}.bind(this))}.bind(this))}};e.exports=a}),null);